---
import { UTKAST_API_URL } from "astro:env/server";
import { ChevronRightIcon } from "@navikt/aksel-icons";
import { BodyLong, BodyShort, Heading } from "@navikt/ds-react";
import ErrorBox from "@src/components/error/Error.astro";
import Pencil from "@src/img/Pencil";
import type { Language } from "@src/language/language";
import { text } from "@src/language/text";
import dayjs from "dayjs";
import { fetchUtkast } from "../../utils/fetch";
import logger from "../../utils/logger.ts";
import { sortByOpprettet } from "../../utils/sorting";
import { getOboToken } from "../../utils/token";
import IngenUtkast from "../ingen/IngenUtkast.astro";
import styles from "./Utkast.module.css";
import type { UtkastElement } from "./UtkastTypes.ts";

interface Props {
  language: Language;
}

const oboToken = await getOboToken(Astro.locals.token);
const { language } = Astro.props;

let data = [];
let isError = false;

try {
  data = await fetchUtkast(oboToken, UTKAST_API_URL);
} catch (error) {
  logger.error("Error fetching utkast: " + error);
  isError = true;
}

const dateFormatter = (date: string) => dayjs(date).format("DD.MM.YYYY");
---

<>
  {
    isError ? (
      <ErrorBox language={language} />
    ) : data?.length == 0 ? (
      <IngenUtkast language={language} />
    ) : (
      <ul class={styles.utkastList}>
        {data?.sort(sortByOpprettet).map((utkast: UtkastElement) => (
          <li class={styles.container}>
            <a
              href={utkast.link}
              class={styles.link}
              data-umami-event="utkast-Ã¥pnet"
            >
              <div class={styles.top}>
                <div class={styles.wrapper}>
                  <div class={styles.ikon}>
                    <Pencil aria-hidden={true} />
                  </div>
                  <BodyShort size="medium" className={styles.utkastNavn}>
                    {text.utkast[language]}
                  </BodyShort>
                </div>
                <div class={`${styles.wrapper} ${styles.endretTekst}`}>
                  <BodyLong size="small">
                    {text.opprettet[language] + dateFormatter(utkast.opprettet)}
                  </BodyLong>
                  <ChevronRightIcon
                    className={styles.chevron}
                    fontSize="1.25rem"
                    aria-hidden={true}
                    aria-label="Chevron"
                  />
                </div>
              </div>
              <div class={styles.bottom}>
                <Heading
                  size="xsmall"
                  level="2"
                  className={styles.utkastTittel}
                >
                  {utkast.tittel}
                </Heading>
              </div>
            </a>
          </li>
        ))}
      </ul>
    )
  }
</>
